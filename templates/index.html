{% extends "base.html" %}

{% block content %}
<p class="text-2xl text-white mb-8">
    <span id="counter" class="font-bold">0</span>
</p>
<img src="{{ current_planet }}" alt="planet" id="planet" class="w-64 h-64 rounded-full cursor-pointer hover:scale-105 transition duration-200">
<p class="text-xl text-white mt-4">Next Drop <span id="timer" class="font-bold">01:00:00</span></p>
{% endblock %}

{% block scripts %}
<script>
    let count = parseInt(localStorage.getItem('clickCount')) || 0;
    const counter = document.getElementById('counter');
    const planet = document.getElementById('planet');
    const timer = document.getElementById('timer');

    counter.textContent = count;

    let savedTime = localStorage.getItem('timerValue');
    if (savedTime) {
        if (savedTime === '00:00:00') {
            timer.textContent = '01:00:00';
        } else {
            timer.textContent = savedTime;
        }
    } else {
        timer.textContent = '01:00:00';
    }

    planet.addEventListener('click', () => {
        count++;
        counter.textContent = count;

        localStorage.setItem('clickCount', count);
        planet.classList.add('scale-110');
        setTimeout(() => {
            planet.classList.remove('scale-110');
        }, 100);
    });

    function resetTimer() {
        hours = 1;
        minutes = 0;
        seconds = 0;

        let newTime = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        timer.textContent = newTime;
        localStorage.setItem('timerValue', newTime);
    }

    function updateTimer() {
        let time = timer.textContent.split(':');
        let hours = parseInt(time[0]);
        let minutes = parseInt(time[1]);
        let seconds = parseInt(time[2]);

        if (seconds > 0) {
            seconds--;
        } else if (minutes > 0) {
            minutes--;
            seconds = 59;
        } else if (hours > 0) {
            hours--;
            minutes = 59;
            seconds = 59;
        } else {
            clearInterval(timerInterval);

            fetch('/drop_planet')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        Swal.fire({
                            title: `Planet Dropped: ${data.planet.planet_name}`,
                            text: `You have successfully dropped a planet`,
                            imageUrl: data.planet.planet_path,
                            imageWidth: 200,
                            imageHeight: 200,
                            showConfirmButton: true,
                            showCancelButton: true,
                            showDenyButton: true,
                            confirmButtonText: 'Get it!',
                            denyButtonText: 'Equip it!',
                            denyButtonColor: '#4CAF50',
                            confirmButtonColor: '#3085d6',
                            cancelButtonColor: '#d33',
                            cancelButtonText: 'Throw it away',
                            allowOutsideClick: false,
                        }).then((result) => {
                            if (result.isConfirmed) {
                                resetTimer();
                                timerInterval = setInterval(updateTimer, 1000);
                            } else if (result.isDenied) {
                                console.log(data.planet);
                                fetch('/change_planet', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                    },
                                    body: JSON.stringify({ planet_path: data.planet.planet_path })
                                })
                                .then(response => response.json())
                                .then(data => {
                                    if (data.status === 'success') {
                                        document.getElementById('planet').src = data.planet_path;
                                        Swal.fire('Success', 'Planet changed successfully.', 'success');
                                    } else {
                                        Swal.fire('Error', 'Failed to change planet.', 'error');
                                    }
                                })
                                .catch(error => {
                                    console.error('Error:', error);
                                    Swal.fire('Error', 'An error occurred.', 'error');
                                });

                                resetTimer();
                                timerInterval = setInterval(updateTimer, 1000);
                            } else if (result.dismiss === Swal.DismissReason.cancel) {
                                Swal.fire({
                                    title: 'Are you sure you want to delete this planet?',
                                    text: "You won't be able to revert this! You will get 10 coins back.",
                                    icon: 'warning',
                                    showCancelButton: true,
                                    confirmButtonColor: '#3085d6',
                                    cancelButtonColor: '#d33',
                                    confirmButtonText: 'Yes, delete it!'
                                }).then((result) => {
                                    if (result.isConfirmed) {
                                        fetch('/delete_item', {
                                            method: 'POST',
                                            headers: {
                                                'Content-Type': 'application/json',
                                            },
                                            body: JSON.stringify({ item_id: data.planet.id })
                                        })
                                        .then(response => response.json())
                                        .then(data => {
                                            if (data.status === 'success') {
                                                Swal.fire('Success', 'Planet deleted successfully.', 'success');
                                                document.getElementById('money').textContent = data.money;
                                                resetTimer();
                                                timerInterval = setInterval(updateTimer, 1000);
                                            } else {
                                                Swal.fire('Error', 'Failed to delete planet.', 'error');
                                                resetTimer();
                                                timerInterval = setInterval(updateTimer, 1000);
                                            }
                                        })
                                        .catch(error => {
                                            console.error('Error:', error);
                                            Swal.fire('Error', 'An error occurred.', 'error');
                                            resetTimer();
                                            timerInterval = setInterval(updateTimer, 1000);
                                        });
                                    } else {
                                        resetTimer();
                                        timerInterval = setInterval(updateTimer, 1000);
                                    }
                                });
                            }
                        });
                    } else {
                        Swal.fire('Error', data.message, 'error');
                    }
                });

        }

        let newTime = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        timer.textContent = newTime;

        localStorage.setItem('timerValue', newTime);
    }

    let timerInterval = setInterval(updateTimer, 1000);
</script>
{% endblock %}
